# MyGolfTracker ASCII 流程图

## 🎯 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           MyGolfTracker 系统架构                                │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面层     │    │   API网关层      │    │   业务逻辑层     │
│                │    │                │    │                │
│ • HTML/CSS/JS  │◄──►│ • FastAPI      │◄──►│ • 视频分析服务   │
│ • 视频播放器    │    │ • 路由管理      │    │ • 轨迹优化算法   │
│ • 数据可视化    │    │ • 请求处理      │    │ • 状态机管理     │
│ • 用户交互      │    │ • 响应格式化    │    │ • 策略管理器     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   数据存储层     │    │   检测引擎层     │    │   工具服务层     │
│                │    │                │    │                │
│ • 临时文件存储   │    │ • YOLOv8检测器  │    │ • FFmpeg处理    │
│ • 分析结果缓存   │    │ • 姿态检测器    │    │ • 文件管理服务   │
│ • 训练数据收集   │    │ • 杆头检测      │    │ • 日志服务      │
│ • 模型文件      │    │ • 置信度过滤    │    │ • 响应服务      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🔄 数据处理流程

```
用户上传视频
    │
    ▼
┌─────────────────┐
│  文件类型检查    │ ← MP4, MOV, AVI
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 视频兼容性验证   │ ← 分辨率, 格式检查
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 生成任务ID      │ ← UUID
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 启动后台分析线程 │ ← 异步处理
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 视频帧提取      │ ← FFmpeg
└─────────────────┘
    │
    ▼
┌─────────────────┬─────────────────┐
│   YOLOv8检测    │   姿态检测      │
│                │                │
│ • 杆头检测      │ • MediaPipe     │
│ • 置信度过滤    │ • 关键点提取    │
│ • 坐标转换      │ • 姿态分析      │
└─────────────────┴─────────────────┘
    │
    ▼
┌─────────────────┐
│ 轨迹数据整合    │ ← 合并检测结果
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 自动补齐算法    │ ← 线性插值填补
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 挥杆状态机分析  │ ← 状态转换
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 生成分析结果    │ ← 完整数据包
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 更新前端显示    │ ← 实时更新
└─────────────────┘
```

## 🎨 前端模块交互

```
main.js (主控制器)
    │
    ├── upload-module.js
    │   └── 文件上传处理
    │       └── 启动分析任务
    │
    ├── video-player-module.js
    │   └── 视频播放控制
    │       └── 动态视频分析显示
    │
    ├── results-module.js
    │   └── 统计信息显示
    │       └── 检测率, 帧数统计
    │
    ├── trajectory-module.js
    │   └── 轨迹数据管理
    │       └── 轨迹信息显示
    │
    ├── frame-analysis-module.js
    │   └── 帧分析显示
    │       └── 当前帧检测信息
    │
    └── dual-player-module.js
        └── 双画面对比
            ├── 左侧: 原始检测数据
            └── 右侧: 补齐后数据
```

## 🔌 API接口调用链

```
POST /video
    │
    ├── 文件上传验证
    ├── 生成任务ID
    ├── 启动后台分析
    └── 返回任务ID
    │
    ▼
GET /video/status (轮询)
    │
    ├── 查询任务状态
    ├── 返回进度信息
    └── 分析完成后返回结果
    │
    ▼
GET /visualize/{result_id}
    │
    └── 显示分析结果页面
```

## 🧠 自动补齐算法详细流程

```
原始轨迹数据 (100帧)
    │
    ▼
┌─────────────────┐
│ 识别有效检测点  │ ← 非None, 非零坐标
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 查找缺失间隔    │ ← 最大10帧间隔
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 线性插值填补    │ ← 计算中间值
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 生成补齐轨迹    │ ← 100%检测率
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 创建right_frame │ ← 补齐后数据
│ _detections     │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 标记补齐帧      │ ← is_filled: true
└─────────────────┘
```

## 📊 数据格式示例

```
输入数据:
├── 视频文件: MP4/MOV/AVI
├── 分辨率: 640×640
├── 置信度: 0.01
├── IoU阈值: 0.7
├── 最大检测数: 10
└── 优化策略: auto_fill

输出数据:
├── job_id: "uuid"
├── status: "completed"
└── result:
    ├── frame_detections: [...]      # 原始检测
    ├── right_frame_detections: [...] # 补齐后数据
    ├── club_head_trajectory: [...]   # 优化轨迹
    ├── original_trajectory: [...]    # 原始轨迹
    ├── swing_states: [...]           # 挥杆状态
    └── detection_stats: {...}        # 检测统计
```

## 🚀 部署架构

```
┌─────────────────┐
│   用户浏览器    │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  Nginx代理      │ ← 端口5005
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  FastAPI应用    │ ← Docker容器
└─────────────────┘
         │
         ├── 模型文件 (data/best.pt)
         ├── 临时文件存储
         ├── 分析结果缓存
         └── 训练数据收集
```

## 🔧 关键配置

```
环境变量:
├── MODEL_PATH=data/best.pt
├── 最大并发任务: 2
└── 服务器负载: normal

默认参数:
├── 分辨率: 640×640
├── 置信度: 0.01
├── IoU阈值: 0.7
├── 最大检测数: 10
└── 优化策略: auto_fill
```

---

*这个ASCII流程图提供了MyGolfTracker项目的完整架构概览，包括所有关键组件、数据流程和交互关系。*


